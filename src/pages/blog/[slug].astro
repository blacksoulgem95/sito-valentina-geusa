---
import { getBlogPost } from '@/lib/firebase/firestore-server';
import PageLayout from '@/layouts/PageLayout.astro';
import { Calendar, ArrowLeft } from 'lucide-astro';
import type { MarkdownHeading } from 'astro';
import { renderMarkdownToHtml } from '@/lib/utils/markdown';

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/blog');
}

const post = await getBlogPost(slug);

if (!post) {
  return Astro.redirect('/blog');
}

const publishedDate = post.publishedAt?.toDate?.() || new Date(post.publishedAt?.seconds * 1000) || new Date();
const formattedDate = publishedDate.toLocaleDateString('it-IT', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});
const postBody = renderMarkdownToHtml(post.body);
---

<PageLayout pageTitle={post.seoTitle || post.title}>
  <article class="container mx-auto px-4 py-12 max-w-4xl">
    <a
      href="/blog"
      class="inline-flex items-center text-primary hover:text-primary-dark mb-8"
    >
      <ArrowLeft size={20} class="mr-2" />
      Torna al blog
    </a>

    <header class="mb-8">
      {post.categories && post.categories.length > 0 && (
        <div class="mb-4 flex flex-wrap gap-2">
          {post.categories.map((cat) => (
            <span
              class="inline-block px-3 py-1 rounded-full text-sm font-medium bg-purple-100 text-purple-700"
            >
              {cat}
            </span>
          ))}
        </div>
      )}
      
      <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-4">
        {post.title}
      </h1>
      
      <div class="flex items-center text-gray-600 mb-6">
        <Calendar size={18} class="mr-2" />
        <time datetime={publishedDate.toISOString()}>
          {formattedDate}
        </time>
      </div>

      {post.featuredImage && (
        <div class="aspect-video mb-8 rounded-lg overflow-hidden">
          <img
            src={post.featuredImage}
            alt={post.title}
            class="w-full h-full object-cover"
          />
        </div>
      )}
    </header>

    <div class="prose prose-lg max-w-none">
      <div set:html={postBody} />
    </div>

    {post.tags && post.tags.length > 0 && (
      <footer class="mt-12 pt-8 border-t border-gray-200">
        <div class="flex flex-wrap gap-2">
          <span class="text-sm font-medium text-gray-700 mr-2">Tag:</span>
          {post.tags.map((tag) => (
            <span
              class="inline-block px-3 py-1 rounded-full text-sm bg-gray-100 text-gray-700"
            >
              #{tag}
            </span>
          ))}
        </div>
      </footer>
    )}
  </article>
</PageLayout>

<style>
  .prose {
    color: #374151;
  }

  .prose h1,
  .prose h2,
  .prose h3,
  .prose h4 {
    color: #1f2937;
    font-weight: 700;
    margin-top: 2em;
    margin-bottom: 1em;
  }

  .prose h2 {
    font-size: 2em;
  }

  .prose h3 {
    font-size: 1.5em;
  }

  .prose p {
    margin-bottom: 1.5em;
    line-height: 1.75;
  }

  .prose a {
    color: #ec4899;
    text-decoration: underline;
  }

  .prose a:hover {
    color: #be185d;
  }

  .prose img {
    margin: 2em 0;
    border-radius: 0.5rem;
    max-width: 100%;
    height: auto;
  }

  .prose code {
    background-color: #f3f4f6;
    padding: 0.2em 0.4em;
    border-radius: 0.25rem;
    font-size: 0.875em;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  }

  .prose pre {
    background-color: #1f2937;
    color: #f9fafb;
    padding: 1em;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin: 1.5em 0;
  }

  .prose pre code {
    background-color: transparent;
    padding: 0;
    color: inherit;
  }

  .prose ul,
  .prose ol {
    margin: 1.5em 0;
    padding-left: 1.625em;
  }

  .prose li {
    margin: 0.5em 0;
  }

  .prose blockquote {
    border-left: 4px solid #ec4899;
    padding-left: 1em;
    margin: 1.5em 0;
    font-style: italic;
    color: #6b7280;
  }
</style>
