---
import {
    Instagram,
    Linkedin,
    Mail,
    MessageCircle,
    Sparkles,
} from "lucide-astro";
import Card from "./ui/Card.astro";
import Input from "./ui/Input.astro";
import Textarea from "./ui/Textarea.astro";

// Contact.astro
---

<div class="container mx-auto px-4">
    <!-- Titolo e sottotitolo -->
    <div class="text-center mb-12">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-4">
            Creiamo qualcosa <span class="text-primary-dark">insieme</span>
        </h1>
        <p class="text-gray text-lg max-w-3xl mx-auto">
            Sono sempre entusiasta di intraprendere nuovi progetti e collaborare
            con professionisti creativi. Per qualsiasi opportunit√†, non esitare
            a contattarmi.
        </p>
    </div>

    <!-- Cards Container - Layout dell'immagine -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 max-w-6xl mx-auto mb-16">
        <!-- Card Scrivimi - Sinistra -->
        <Card
            variant="shadow-md"
            size="spacious"
            class="flex flex-col justify-center"
        >
            <div class="flex items-start gap-6">
                <div class="form-header-icon flex-shrink-0">
                    <Mail size={40} />
                </div>
                <div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">
                        Scrivimi
                    </h3>
                    <p class="text-gray">
                        Puoi inviarmi un'email in qualsiasi momento!
                    </p>
                </div>
            </div>
        </Card>

        <!-- Card Form - Destra -->
        <Card variant="shadow-md" size="spacious">
            <div class="flex items-start gap-4 mb-6">
                <div class="form-header-icon flex-shrink-0">
                    <MessageCircle size={40} />
                </div>
                <div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-1">
                        Parliamone assieme
                    </h3>
                    <p class="text-gray">
                        Mi piacerebbe conoscere il tuo progetto! ‚ú®
                    </p>
                </div>
            </div>

            <form
                id="contact-form-component"
                class="grid grid-cols-1 md:grid-cols-2 gap-4"
            >
                <!-- Colonna sinistra - 3 input -->
                <div class="space-y-4 md:col-span-1">
                    <Input
                        type="text"
                        name="nome"
                        id="contact-nome"
                        placeholder="Nome*"
                        required
                    />
                    <Input
                        type="email"
                        name="email"
                        id="contact-email"
                        placeholder="Email*"
                        required
                        autocomplete="email"
                    />
                    <Input
                        type="tel"
                        name="telefono"
                        id="contact-telefono"
                        placeholder="Telefono"
                        autocomplete="tel"
                    />
                </div>

                <!-- Colonna destra - Textarea + Button -->
                <div
                    class="md:col-span-1 flex flex-col gap-4 h-full min-h-[200px]"
                >
                    <Textarea
                        name="messaggio"
                        id="contact-messaggio"
                        placeholder="Messaggio*"
                        required
                        class="flex-1"
                        resize="none"
                    />
                    <div class="flex items-start gap-3">
                        <input
                            type="checkbox"
                            id="contact-privacy"
                            name="privacy"
                            required
                            class="mt-1 w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary"
                        />
                        <label
                            for="contact-privacy"
                            class="text-sm text-gray-600"
                        >
                            Accetto la <a
                                href="/privacy-policy"
                                class="text-primary hover:underline"
                                >Privacy Policy</a
                            > e autorizzo il trattamento dei miei dati
                        </label>
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" class="form-submit" id="contact-submit-btn">
                            Invia
                        </button>
                    </div>
                </div>
                <div id="contact-form-message" class="hidden md:col-span-2"></div>
            </form>
        </Card>
    </div>

    <!-- Social Links -->
    <div class="text-center">
        <p class="text-gray mb-6">Tienimi in contatto</p>
        <div class="flex justify-center items-center gap-6">
            <Sparkles size={32} class="text-yellow-400" />
            <a
                href="https://instagram.com/vallmars"
                target="_blank"
                rel="noopener noreferrer"
                class="w-12 h-12 flex items-center justify-center rounded-full border-2 border-gray-300 hover:border-primary hover:bg-primary/10 transition-all"
                aria-label="Instagram"
            >
                <Instagram size={24} />
            </a>
            <a
                href="https://linkedin.com/in/valentinageusa"
                target="_blank"
                rel="noopener noreferrer"
                class="w-12 h-12 flex items-center justify-center rounded-full border-2 border-gray-300 hover:border-primary hover:bg-primary/10 transition-all"
                aria-label="LinkedIn"
            >
                <Linkedin size={24} />
            </a>
            <Sparkles size={32} class="text-yellow-400" />
        </div>
    </div>
</div>

<script>
    const contactForm = document.getElementById('contact-form-component') as HTMLFormElement | null;
    const submitButton = document.getElementById('contact-submit-btn') as HTMLButtonElement | null;
    const messageDiv = document.getElementById('contact-form-message');

    contactForm?.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!contactForm || !submitButton) return;

        const formData = new FormData(contactForm);
        const originalButtonText = submitButton.textContent;

        // Disabilita il pulsante durante l'invio
        submitButton.disabled = true;
        submitButton.textContent = 'Invio in corso...';

        // Rimuovi messaggi precedenti
        if (messageDiv) {
            messageDiv.className = 'hidden md:col-span-2';
            messageDiv.textContent = '';
        }

        try {
            const response = await fetch('/api/contact', {
                method: 'POST',
                body: formData,
            });

            const result = await response.json();

            if (messageDiv) {
                messageDiv.classList.remove('hidden');
                
                if (result.success) {
                    messageDiv.className = 'success-message md:col-span-2';
                    messageDiv.textContent = '‚úÖ Messaggio inviato con successo! Ti risponder√≤ al pi√π presto. üíå';
                    contactForm.reset();
                    
                    // Rimuovi il messaggio dopo 5 secondi
                    setTimeout(() => {
                        messageDiv.classList.add('hidden');
                    }, 5000);
                } else {
                    messageDiv.className = 'error-message md:col-span-2';
                    messageDiv.textContent = `‚ùå ${result.error || 'Si √® verificato un errore. Riprova pi√π tardi.'}`;
                    
                    // Rimuovi il messaggio dopo 5 secondi
                    setTimeout(() => {
                        messageDiv.classList.add('hidden');
                    }, 5000);
                }
            }

        } catch (error) {
            console.error('Errore:', error);
            if (messageDiv) {
                messageDiv.classList.remove('hidden');
                messageDiv.className = 'error-message md:col-span-2';
                messageDiv.textContent = '‚ùå Si √® verificato un errore. Prova a scrivermi direttamente via email.';
                
                // Rimuovi il messaggio dopo 5 secondi
                setTimeout(() => {
                    messageDiv.classList.add('hidden');
                }, 5000);
            }
        } finally {
            // Ripristina il pulsante
            if (submitButton) {
                submitButton.disabled = false;
                submitButton.textContent = originalButtonText || 'Invia';
            }
        }
    });
</script>

<style>
    .success-message {
        padding: 1rem;
        background-color: #d1fae5;
        border: 2px solid #6ee7b7;
        border-radius: 0.5rem;
        color: #065f46;
        font-weight: 500;
        text-align: center;
        margin-top: 1rem;
        animation: slideDown 0.3s ease-out;
    }

    .error-message {
        padding: 1rem;
        background-color: #fee2e2;
        border: 2px solid #fca5a5;
        border-radius: 0.5rem;
        color: #991b1b;
        font-weight: 500;
        text-align: center;
        margin-top: 1rem;
        animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
